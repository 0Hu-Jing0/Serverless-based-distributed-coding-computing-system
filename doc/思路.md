# 基于serverless的分布式编码计算系统

目标：搭建一个原型系统，实现对任意矩阵乘法进行编码，将计算任务（这些任务是异步执行的）分配给部署在serverless中的函数，顺序对接收到函数返回的结果进行解码，直到得到矩阵乘法的计算结果。

## 编码方案

### 编码

- 矩阵A与B相乘，对矩阵A进行编码
  - 当矩阵总行数为奇数时，在最后一行后补一行0，确保编码时的矩阵为偶数行
  - 将矩阵A的每两行分为一组，每组共有3个计算任务，每个计算任务均是向量与矩阵相乘，3个任务分别为a1 * B、a2 * B、（a1+a2）* B
  - 发布计算任务时，将组、编码值（0/1/2->a1/a2/a1+a2）、向量（a1/a2/a1+a2）、矩阵（B）传递给服务器

### 解码

- 按时间顺序接收所有返回值（组、编码值、向量）
  - 每组只需要两个服务器的返回值即可得到计算结果
  - 根据组、编码值进行解码

## Serverless

经过调研后，决定选用[OpenFaaS](https://www.openfaas.com/)框架搭建原型系统

### OpenFaaS

环境部署：在[Windows10上部署k8s环境](https://juejin.cn/post/6856407118669742094#heading-6)，然后[部署OpenFaaS](https://xinchen.blog.csdn.net/article/details/109805296)

函数编写、创建与构建：根据官方文档熟悉OpenFaaS下Python函数的[编写](https://docs.openfaas.com/tutorials/first-python-function/)、[创建](https://docs.openfaas.com/cli/templates/)与[构建](https://docs.openfaas.com/cli/build/)

## 异步执行任务

异步执行任务过程是原型系统中最复杂的部分，在具体实现过程中，决定按照以下步骤依次进行

| 步骤名                                  | 任务分发 | 任务执行 |
| --------------------------------------- | -------- | -------- |
| 1、本地模拟任务的异步执行               | 一       | 异步     |
| 2、调用OpenFaaS函数完成编码计算         | 异步     | 同步     |
| 3、调用OpenFaaS函数异步执行完成编码计算 | 异步     | 异步     |

### 1、本地模拟任务的异步执行（已完成）

通过python的asyncio库实现了异步任务的分发及[异步任务返回值](https://xubiubiu.com/python3-huo-qu-xie-cheng-fan-hui-zhi/)的获取，在本地完成了任务异步执行的模拟

- 本地模拟时，所有任务都存储在一个任务列表中，可以将任务的分发和执行视为同一过程

### 2、调用OpenFaaS函数完成编码计算

在上一个步骤实现了任务异步分发的基础上，将执行函数由本机变为了在OpenFaaS中部署的函数。本任务主要目的是对函数接口

### 3、调用OpenFaaS函数异步执行完成编码计算

这个步骤需要[异步调用OpenFaaS中的函数](https://docs.openfaas.com/reference/async/)，具体执行待进一步调研

## 问题及解决方案

### 1、构建包含numpy库的镜像出错

出错原因是python的numpy/pandas库在第三方依赖库中需要原生的C/C++模块，普通的构建方式在构建镜像时不会下载这些模块。通过[博客](https://github.com/openfaas/faas/issues/1133)解决了这个问题，后来发现这部分在[官方文档](https://docs.openfaas.com/cli/build/#10-apply-build-options)也有说明

#### 本系统中部署镜像步骤（python）

```
1.create
faas-cli new xx(function name) --lang python -p xxxx(image name)
2.build
faas-cli build -f xx.yml(function name) --build-option dev
3.check image
docker images
4.push image
docker push xxxx(local repository/image name)
5.deploy
faas-cli deploy -f xx.yml(function name)
```
